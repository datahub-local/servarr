name: CI

on:
  push:
    branches-ignore:
      - main

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Devbox
        uses: jetify-com/devbox-install-action@v0.14.0

      - name: Helm Dependency build
        run: devbox run init-charts

      - name: Run chart-testing (lint)
        run: devbox run lint-chart

      # - name: Setup upterm session
      #   uses: owenthereal/action-upterm@v1
      #   if: ${{ failure() }}
      #   with:
      #     limit-access-to-actor: true
      #     wait-timeout-minutes: 5
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Devbox
        uses: jetify-com/devbox-install-action@v0.14.0

      - name: Helm Dependency build
        run: devbox run init-charts

      - name: Run Unit Tests
        run: devbox run unittest

      - name: Helm Template
        run: devbox run helm template servarr servarr/ -f .github/ci/ci-values.yaml

      # - name: Setup upterm session
      #   uses: owenthereal/action-upterm@v1
      #   if: ${{ failure() }}
      #   with:
      #     limit-access-to-actor: true
      #     wait-timeout-minutes: 5

  integration-test:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Devbox
        uses: jetify-com/devbox-install-action@v0.14.0

      - name: Set up Docker
        uses: docker/setup-docker-action@v4

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1

      - name: Helm Dependency build
        run: devbox run init-charts

      - name: Start cluster and deploy dependencies
        run: devbox run start-k8s

      - name: Deploy test chart
        run: devbox run test-install

      - name: Run test verification
        run: devbox run test-check

      # - name: Setup upterm session
      #   uses: owenthereal/action-upterm@v1
      #   if: ${{ failure() }}
      #   with:
      #     limit-access-to-actor: true
      #     wait-timeout-minutes: 5

  package:
    runs-on: ubuntu-latest
    needs: integration-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Devbox
        uses: jetify-com/devbox-install-action@v0.14.0

      - name: Helm Dependency build
        run: devbox run init-charts

      - name: Create Package
        run: devbox run helm package servarr/

  docs:
    runs-on: ubuntu-latest
    needs: package
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Run helm-docs and push to the same branch
        uses: losisin/helm-docs-github-action@v1
        with:
          git-push: true
          git-push-user-name: "servarr Bot ðŸ¤–"
          git-push-user-email: "servarr-bot@datahub.local"
          chart-search-root: ./servarr
